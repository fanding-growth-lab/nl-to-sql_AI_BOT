import pandas as pd
from sqlalchemy import create_engine, text
import numpy as np
import matplotlib.pyplot as plt

# matplotlib 한글 설정
plt.rcParams['font.family'] = 'Malgun Gothic'
plt.rcParams['axes.unicode_minus'] = False

# 데이터베이스 연결 설정
engine = create_engine(
    f"mysql+pymysql://readonly_user_business_data:Fanding!Data!@epic-readonly.ceind7azkfjy.ap-northeast-2.rds.amazonaws.com:3306/fanding?charset=utf8mb4",
    echo=False
)

# SQL 쿼리문
query = "SELECT\n    tm.nickname AS creator_nickname,\n    tp.no AS payment_no,\n    tp.seller_creator_no,\n    tp.item,\n    tp.order_name,\n    tp.currency_no,\n    tp.heat,\n    tp.remain_heat,\n    tp.price,\n    tp.remain_price,\n    tp.status,\n    tp.pay_datetime\nFROM\n    t_payment tp\nJOIN\n    t_creator tc ON tp.seller_creator_no = tc.no\nJOIN\n    t_member tm ON tc.member_no = tm.no\nWHERE\n    tm.nickname IN ('강환국 작가', '고래돈공부')\n    AND tp.status IN ('T', 'P')\n    AND tp.pay_datetime IS NOT NULL\n    AND tp.pay_datetime >= '2025-11-01 00:00:00'\n    AND tp.pay_datetime <= '2025-11-30 23:59:59';"

# SQL 쿼리 실행 및 데이터 로드
df_sales = pd.read_sql(text(query), engine)

# 비즈니스 규칙에 따른 실제 매출 금액 계산
conditions = [
    df_sales['currency_no'] == 1,
    df_sales['currency_no'] == 2,
    df_sales['currency_no'].isnull()
]

choices = [
    df_sales['remain_price'],
    df_sales['remain_price'] * 1360,
    df_sales['remain_heat'] * 110
]

df_sales['actual_sales_amount'] = np.select(conditions, choices, default=0)

# 크리에이터별 주요 매출 지표 집계
# 총 매출, 결제 건수, 건당 평균 매출
revenue_summary = df_sales.groupby('creator_nickname').agg(
    total_revenue=('actual_sales_amount', 'sum'),
    transaction_count=('payment_no', 'count'),
    average_transaction_value=('actual_sales_amount', 'mean')
).reset_index()

# item(결제 상품 구분)별 매출 기여도 분석
item_revenue_breakdown = df_sales.groupby(['creator_nickname', 'item']).agg(
    item_total_revenue=('actual_sales_amount', 'sum'),
    item_transaction_count=('payment_no', 'count')
).reset_index()


# 결과 출력
print("2025년 11월 '강환국 작가'와 '고래돈공부' 크리에이터 매출 차이 분석:\n")
print("1. 크리에이터별 주요 매출 지표:")
print(revenue_summary.to_string(index=False))
print("\n")
print("2. 크리에이터별 결제 상품(item) 종류별 매출 기여도:")
print(item_revenue_breakdown.to_string(index=False))

# 시각화: item별 매출 기여도
if not item_revenue_breakdown.empty:
    fig, axes = plt.subplots(1, 2, figsize=(16, 7))
    creators = item_revenue_breakdown['creator_nickname'].unique()

    for i, creator in enumerate(creators):
        creator_data = item_revenue_breakdown[item_revenue_breakdown['creator_nickname'] == creator]
        # 매출 비중이 0인 item은 제외 (파이 차트에서 보이지 않도록)
        creator_data = creator_data[creator_data['item_total_revenue'] > 0]

        if not creator_data.empty: # 데이터가 있는 경우에만 그리기
            axes[i].pie(creator_data['item_total_revenue'],
                        labels=creator_data['item'] + ' (' + (creator_data['item_total_revenue'] / creator_data['item_total_revenue'].sum() * 100).round(1).astype(str) + '%)',
                        autopct='%1.1f%%', startangle=90, wedgeprops={'edgecolor': 'black'})
            axes[i].set_title(f"'{creator}'의 결제 상품(item)별 매출 비중", fontsize=14)
            axes[i].axis('equal') # Equal aspect ratio ensures that pie is drawn as a circle.
        else: # 데이터가 없는 경우 빈 차트 표시 또는 메시지 출력
            axes[i].set_title(f"'{creator}'의 결제 상품(item)별 매출 비중 (데이터 없음)", fontsize=14)
            axes[i].text(0.5, 0.5, '매출 데이터 없음', horizontalalignment='center', verticalalignment='center', transform=axes[i].transAxes)

    plt.tight_layout()
    plt.show()